on_actions = {
  on_startup = {
    effect = {
      every_country = {
        limit = {
          is_faction_leader = yes
        }
        set_faction_spymaster = yes
      }

      GER = {
        # initialize array of minelaying countries
        init_minelaying_countries_array = yes
        # initialize countries to grind array
        init_grinding_period = yes

        # loop by minelaying countries, giving them back their damn minelayers
        if = {
          limit = { are_mines_enabled = yes }

          for_each_scope_loop = {
            array = minelaying_countries

            meta_effect = {
              text = {
                load_oob = [CURRENT_TAG]_1936_minelayers
              }
              CURRENT_TAG = "[THIS.GetTag]"
            }
          }
        }
        # loop by minelaying countries, giving them compensation for deleted ships
        else = {
          for_each_scope_loop = {
            array = minelaying_countries

            meta_effect = {
              text = {
                load_oob = [CURRENT_TAG]_1936_minelayers_replacement
              }
              CURRENT_TAG = "[THIS.GetTag]"
            }
          }
        }
        # what if strat. bombers allowed?
        if = {
          limit = { are_strats_enabled = yes }

          every_country = {
            limit = {
              OR = {
                original_tag = SOV
                original_tag = GER
              }
            }

            set_technology = {
              strategic_bomber1 = 1
            }
          }

          SOV = { load_oob = "SOV_1936_strats" }
        }

      }

      # if = {
      #   limit = {
      #     is_debug = yes
      #   }

      #   every_country = {
      #     print_variables = {
      #       file = "variable_dump"
      #       append = yes
      #       print_global = yes
      #     }
      #   }
      # }
    }
  }

  on_join_faction = {
    effect = {
      if = {
        limit = {
          NOT = {
            has_country_flag = nma_faction_member
          }
        }

        set_temp_variable = { faction_leader = FROM }
        set_temp_variable = { newcomer = THIS }

        random_country = {
          limit = {
            is_spymaster = yes
            is_in_faction_with = faction_leader
          }

          set_temp_variable = { spymaster = THIS }

          every_country = {
            limit = {
              var:spymaster = {
                check_variable = { has_collaboration@PREV > 0 }
              }
            }

            var:spymaster = {
              set_temp_variable = { spymaster_collaboration = has_collaboration@PREV }
            }
            var:newcomer = {
              set_temp_variable = { newcomer_collaboration = has_collaboration@PREV }
            }

            if = {
              limit = {
                check_variable = { spymaster_collaboration > newcomer_collaboration }
              }

              var:newcomer = {
                set_collaboration = {
                  target = PREV
                  value = spymaster_collaboration
                }
              }
            }

          }

        }

        set_country_flag = nma_faction_member
      }
    }
  }

  on_state_control_changed = {
    effect = {
      set_temp_variable = {
        current_state = FROM.FROM
      }

      if = {
        limit = {
          
          ROOT = {
            OR = {
              original_tag = JAP
              is_in_faction_with = JAP
            }
            all_enemy_country = {
              divisions_in_state = {
                size < 1
                state = current_state
              }
            }
          }

          var:current_state = {
            OR = {
              region = 83       # Solomon Sea
              region = 91       # Arafura Sea
              region = 93       # Java Sea
              region = 97       # Eastern Micronesia
              region = 105      # Hawaii Ridge
              region = 158      # Sunda Islands
              region = 159      # Borneo
              region = 160      # Philippines
              region = 167      # New Guinea
              region = 172      # Pacific Line Ridge
              region = 178      # West Polynesia
              region = 179      # French Polynesia
              region = 187      # Sumatra              
            }
          }

        }
        log = "[?current_state.GetName] goes to [ROOT.GetName]"
        ROOT = {
          set_state_controller = current_state
        }
      }
    }
  }

  # ROOT is capitulated country, FROM is winner
  on_capitulation = {
    effect = {
      if = {
        limit = {
          is_in_array = {
            array = GLOBAL.grind_countries
            value = ROOT
          }
          check_variable = {
            ROOT.grinding_period > 0
          }
        }
        
        # Setting country flag to prevent grinding mission against this country
        ROOT = {
          set_country_flag = grind_time_has_gone
        }

        if = {                                      # Handling Ethiopia capitulation
          limit = {
            ROOT = {
              original_tag = ETH
            }            
          }

          ROOT = {
            white_peace = FROM
          }

          FROM = {
            country_event = nma_grinding.1
          }
        } else_if = {                               # Handling Portugal capitulation
          limit = {
            ROOT = {
              original_tag = POR
            }
            FROM = {  
              original_tag = SPR
              has_government = fascism
            }
          }

          ROOT = {
            white_peace = FROM
          }

          FROM = {
            transfer_state = 112
            transfer_state = 179
            transfer_state = 180
            transfer_state = 181
            transfer_state = 795
          }
        } else_if = {                               # Handling Finland, Afganistan and Iran capitulation
          limit = {
            ROOT = {
              OR = {
                original_tag = FIN
                original_tag = AFG
                original_tag = PER
              }
            }
          }

          FROM = {
            annex_country = {
              target = ROOT
            }
          }
        }
      }
    }
  }

  #FROM is war target ROOT is war mongerer
  on_declare_war = {
    effect = {
      
      if = {
        limit = {
          FROM = {
            is_ai = yes
            NOT = { has_country_flag = grind_time_has_gone }
            NOT = { is_in_faction = yes }
            check_variable = {
              var = THIS.grinding_period
              value = 0
              compare = not_equals
            }
          }
        }

        meta_effect = {
          text = {
            set_country_flag = grinding_[TARGET]
          } 
          TARGET = "[FROM.GetTag]"
        }

        FROM = {
          add_ai_strategy  = {
            type = garrison_reinforcement_priority
            value = -99
          }
        }

      }
    }
  }
}
