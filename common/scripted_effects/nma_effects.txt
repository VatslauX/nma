init_minelaying_countries_array = {
  clear_array = minelaying_countries

  add_to_array = { minelaying_countries = AST }
  add_to_array = { minelaying_countries = BRA }
  add_to_array = { minelaying_countries = DEN }
  add_to_array = { minelaying_countries = ENG }
  add_to_array = { minelaying_countries = FIN }
  add_to_array = { minelaying_countries = FRA }
  add_to_array = { minelaying_countries = GER }
  add_to_array = { minelaying_countries = GRE }
  add_to_array = { minelaying_countries = HOL }
  add_to_array = { minelaying_countries = ITA }
  add_to_array = { minelaying_countries = JAP }
  add_to_array = { minelaying_countries = NOR }
  add_to_array = { minelaying_countries = POL }
  add_to_array = { minelaying_countries = ROM }
  add_to_array = { minelaying_countries = SOV }
  add_to_array = { minelaying_countries = SPR }
  add_to_array = { minelaying_countries = USA }
  add_to_array = { minelaying_countries = YUG }
  add_to_array = { minelaying_countries = CAN }
  add_to_array = { minelaying_countries = CHI }
  add_to_array = { minelaying_countries = MEX }
  add_to_array = { minelaying_countries = SIA }
}

init_united_front_countries_array = {
  clear_array = GLOBAL.united_front_countries

  add_to_array = { GLOBAL.united_front_countries = CHI }
  add_to_array = { GLOBAL.united_front_countries = PRC }
  add_to_array = { GLOBAL.united_front_countries = YUN }
  add_to_array = { GLOBAL.united_front_countries = SIK }
  add_to_array = { GLOBAL.united_front_countries = XSM }
  add_to_array = { GLOBAL.united_front_countries = GXC }
  add_to_array = { GLOBAL.united_front_countries = SHX }
}

init_uk_dominions_array = {
  clear_array = uk_dominions

  add_to_array = { uk_dominions = CAN }
  add_to_array = { uk_dominions = RAJ }
  add_to_array = { uk_dominions = SAF }
  add_to_array = { uk_dominions = AST }
  add_to_array = { uk_dominions = NZL }
}

init_grind_countries = {
  clear_array = GLOBAL.grind_countries

  add_to_array = { GLOBAL.grind_countries = ETH }
  add_to_array = { GLOBAL.grind_countries = YUG }
  add_to_array = { GLOBAL.grind_countries = GRE }
  add_to_array = { GLOBAL.grind_countries = POR }
  add_to_array = { GLOBAL.grind_countries = FIN }
  add_to_array = { GLOBAL.grind_countries = AFG }
  add_to_array = { GLOBAL.grind_countries = PER }
  add_to_array = { GLOBAL.grind_countries = BUL }
}

ensure_united_front_exists = {
  init_united_front_countries_array = yes

  if = {
    limit = {
      NOT = { CHI = { is_faction_leader = yes } }
    }

    CHI = {
      set_rule = { can_create_factions = yes }
      create_faction = chinese_united_front
    }

  }

  for_each_scope_loop = {
    array = GLOBAL.united_front_countries

    if = {
      limit = {
        NOT = {
          OR = {
            is_faction_leader = yes
            is_in_faction_with = CHI
          }
        }
      }

      CHI = {
        # THIS is CHI
        # PREV is loop scope
        add_to_faction = PREV
      }

      if = {
  			limit = {
  				is_literally_china = yes
  				has_DLC = "Waking the Tiger"
  			}
  			CHI_set_ally_strat_on_current_leader = yes #sets ally strategy to current Chinese leader
  		}

      add_ai_strategy = {
				type = alliance
				id = "CHI"
				value = 200
			}
    }
  }

  set_global_flag = CHI_unite
}

add_faction_members_collaboration = {
  for_each_scope_loop = {
    array = faction_members

    if = {
      limit = {
        has_collaboration = {
          target = FROM
          value < 1.0
        }
      }

      add_collaboration = {
        target = FROM
        value = 0.2
      }
    }
  }
}

add_faction_members_collaboration_excellent = {
  for_each_scope_loop = {
    array = faction_members

    if = {
      limit = {
        has_collaboration = {
          target = FROM
          value < 1.0
        }
      }

      add_collaboration = {
        target = FROM
        value = 0.4
      }
    }
  }
}

nma_annex_country = {
  FROM = {
    every_controlled_state = {
      set_state_flag = marked_for_compliance
    }
  }
  PREV = {
    annex_country = { target = FROM transfer_troops = yes }
    every_controlled_state = {
      limit = {
        has_state_flag =  marked_for_compliance
      }
      set_compliance = 70
      clr_state_flag = marked_for_compliance
    }
  }
}

init_grinding_period = {
  # initializing array of allowed to grind countries
  init_grind_countries = yes
 
  # loop over these countries
  for_each_scope_loop = {
    array = GLOBAL.grind_countries
 
    # there are rules for grinding in months from 1 to 12
    for_loop_effect = {
      start = 1     # start
      end = 13      # less_than rule
      break = for_break
 
      # dirty hack to interpolate variables into a code
      meta_effect = {
 
        text = {
          if = {
            limit = {
              # checking game rule for THIS country if it has unlimited grinding period
              OR = {
                has_game_rule = {
                  rule = NMA_[CURRENT_TAG]_GRINDING
                  option = NMA_UNLIMITED_GRIND
                }
                NOT = { is_ai = yes }
              }
            }
 
            # setting unlimited grinding period (0)
            set_variable = { grinding_period = 0 }
 
            # breaking the loop, no need to overload CPU
            set_temp_variable = { for_break = 1 }
          }
          else = {
            # here we go again...
            # checking rule against current tag and current index
            if = {
              limit = {
                has_game_rule = {
                  rule = NMA_[CURRENT_TAG]_GRINDING
                  option = NMA_[INDEX]_MONTH_GRIND
                }
              }
 
              # you know, that one month has 30 days in average
              set_temp_variable = { month = 30 }
              multiply_temp_variable = { month = [INDEX] }
 
              # settings grinding period in days
              set_variable = { grinding_period = month }
 
              set_temp_variable = { for_break = 1 }
              # ground control to major Tom...
            }
          }
        }
 
        CURRENT_TAG = "[THIS.GetTag]"     # ETH, YUG, GRE etc.
        INDEX = v                         # [1, 12]
      }
    }
  }
 
  for_each_scope_loop = {
    array = GLOBAL.grind_countries
 
    log = "[THIS.GetNameDef] has grinding period [?grinding_period]"
  }
}
